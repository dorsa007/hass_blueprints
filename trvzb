blueprint:
  name: ğŸ§  Sonoff TRVZB â€“ Synchronizace externÃ­ teploty (bez pÅ™epÃ­nÃ¡nÃ­ external2)
  description: >
    Tento blueprint automaticky synchronizuje teplotu z externÃ­ho senzoru
    (napÅ™. Ecowitt, Aqara, Shelly, apod.) do hlavice Sonoff TRVZB.

    ğŸ”§ ZajiÅ¡Å¥uje, Å¾e hlavice vÅ¾dy pouÅ¾Ã­vÃ¡ reÅ¾im **external** (a ne external2/3).
    ğŸ”„ SpouÅ¡tÃ­ se pÅ™i zmÄ›nÄ› teploty nebo kaÅ¾dou hodinu.
    âš™ï¸ Filtruje malÃ© zmÄ›ny teploty (napÅ™. < 0.2 Â°C), aby se hlavice zbyteÄnÄ›
    nezatÄ›Å¾ovala.
    ğŸš¨ OÅ¡etÅ™uje stavy `unknown` a `unavailable`.

  domain: automation

  input:
    external_temperature_sensor:
      name: ğŸŒ¡ï¸ ExternÃ­ teplotnÃ­ senzor
      description: Entita senzoru teploty (napÅ™. Ecowitt, Aqara, Shelly...)
      selector:
        entity:
          filter:
            - domain: sensor
              device_class: temperature

    trv_external_temperature_input:
      name: ğŸ”§ Hlavice Sonoff TRVZB â€“ externÃ­ teplota
      description: Entita ÄÃ­sla (`number.sonoff_trvzb_external_temperature_input`)
      selector:
        entity:
          multiple: true
          filter:
            - domain: number
              device_class: temperature

    trv_temperature_sensor_select:
      name: ğŸ§­ VÃ½bÄ›r senzoru teploty (select)
      description: Entita typu `select`, napÅ™. `select.trv_kuchyne_zigbee_temperature_sensor_select`
      selector:
        entity:
          filter:
            - domain: select

    temperature_change_threshold:
      name: ğŸ”º MinimÃ¡lnÃ­ zmÄ›na teploty pro aktualizaci
      description: |
        Hodnota zmÄ›ny (v Â°C), po jejÃ­mÅ¾ pÅ™ekroÄenÃ­ se teplota odeÅ¡le do TRV.
        Nastavte 0 pro okamÅ¾itÃ© aktualizace bez filtru.
      default: 0.2
      selector:
        number:
          min: 0
          max: 2
          step: 0.1
          mode: slider
          unit_of_measurement: Â°C

mode: single

triggers:
  - trigger: state
    entity_id: !input external_temperature_sensor
  - trigger: time_pattern
    hours: /1

variables:
  external_temperature_sensor: !input external_temperature_sensor
  trv_external_temperature_input: !input trv_external_temperature_input
  select_entity: !input trv_temperature_sensor_select
  threshold: !input temperature_change_threshold

conditions:
  - condition: template
    value_template: >
      {{ states(external_temperature_sensor) not in ['unknown', 'unavailable', None, 'none'] }}

actions:
  # ğŸ§­ Zkontroluj, zda hlavice pouÅ¾Ã­vÃ¡ "external"
  - choose:
      - conditions: >
          {{ states(select_entity) != 'external' }}
        sequence:
          - action: select.select_option
            data:
              entity_id: "{{ select_entity }}"
              option: "external"
          - delay: "00:00:02"

  # ğŸŒ¡ï¸ NastavenÃ­ teploty do hlavice, pokud se zmÄ›nila o vÃ­ce neÅ¾ threshold
  - repeat:
      for_each: !input trv_external_temperature_input
      sequence:
        - variables:
            trv_entity: "{{ repeat.item }}"
            current_value: "{{ states(trv_entity) | float(0) }}"
            new_value: "{{ states(external_temperature_sensor) | float(0) }}"
        - condition: template
          value_template: >
            {% set new = states(external_temperature_sensor) | float(0) %}
            {% set cur = states(trv_entity) | float(0) %}
            {{ threshold == 0 or ((new - cur) | abs > threshold) }}
        - delay: "00:00:02"
        - action: number.set_value
          data:
            value: "{{ new_value }}"
            entity_id: "{{ trv_entity }}"
          alias: "Nastavit externÃ­ teplotu do TRVZB"

  # ğŸª¶ (volitelnÃ©) ZÃ¡znam do logu / notifikace
  - action: system_log.write
    data:
      message: >
        [TRVZB Sync] AktualizovÃ¡no: {{ external_temperature_sensor }} = {{ states(external_temperature_sensor) }} Â°C â†’ {{ trv_external_temperature_input }} (reÅ¾im: {{ states(select_entity) }})
      level: info
